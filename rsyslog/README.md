### **OTUS — Administrator Linux. Professional.**  
#### **Домашнее задание №17 — Централизованный сбор логов**

**Цель:**  
Научиться проектировать централизованную систему логирования и изучить особенности разных решений для сбора логов.

**Критерии приёма:**  
1. Поднимаются две ВМ: `web` и `log`;
2. На `web` развёрнут `nginx`;
3. На `log` — центральный лог-сервер (в этом случае — `rsyslog`);
4. Все критичные логи с `web` собираются и локально, и удалённо;
5. Все логи `nginx` передаются только на удалённый сервер;
6. Аудит следит за изменением конфигураций nginx и передаёт события удалённо.

---

#### **Ход выполнения**

1. **Развёртывание стенда:**
   - Используется Vagrant и Ansible;
   - Поднимаются машины:
     - `web` (nginx, audit);
     - `log` (rsyslog-сервер);
   - Конфигурации заданы в ansible-ролях: `web`, `log`, `audit`.

2. **Настройка rsyslog-сервера (`log`):**
   - Включён TCP-приём логов на 514 порту;
   - Создан шаблон для логирования по источникам;
   - Проверено получение логов с клиента:
     ```
     tail -f /var/log/remote/web/...
     ```

3. **Настройка клиента (`web`):**
   - Отключена локальная запись nginx-логов (`access.log`, `error.log`);
   - В конфиге `rsyslog` добавлена отправка всех логов nginx на сервер:
     ```
     if $programname == 'nginx' then @@192.168.56.12:514
     ```
   - Для критичных логов настроена дублирующая запись и на локальный диск:
     ```
     *.crit /var/log/critical.log
     *.crit @@192.168.56.12:514
     ```

4. **Настройка аудита:**
   - Установлен и активирован `auditd`;
   - Добавлено правило:
     ```
     -w /etc/nginx/nginx.conf -p wa -k nginx_conf_change
     ```
   - Проверка срабатывания:
     ```
     ausearch -k nginx_conf_change
     ```

5. **Проверка работоспособности:**
   - После редактирования nginx-конфига срабатывает audit-правило;
   - Все логи уходят на `log`-сервер;
   - На стороне `log`-сервера логирование разделяется по хостам.

---

#### **Вывод**

В результате:
- настроена централизованная система сбора логов на основе `rsyslog`;
- критичные и nginx-логи перенаправлены удалённо;
- настроен аудит конфигурационных файлов nginx;
- все действия автоматизированы через Ansible;
- стенд полностью соответствует требованиям задания.
