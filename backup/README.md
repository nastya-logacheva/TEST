### **OTUS — Administrator Linux. Professional.**  
#### **Домашнее задание №18 — Настраиваем бэкапы**

**Цель:**  
Научиться настраивать резервное копирование с помощью утилиты `borg`.

**Критерии приёма:**  
1. Поднят стенд с двумя машинами: `backup_server` и `client`;  
2. С клиента выполняется бэкап каталога `/etc` на удалённый `backup_server`;  
3. Используется шифрование (ключ или пароль);  
4. Бэкапы размещаются в `/var/backup` (как отдельная точка монтирования);  
5. Имя бэкапа содержит дату/время;  
6. Настроена ротация: хранить 1 бэкап на конец месяца за год и последние 3 месяца — с копиями за каждый день.

---

#### **Ход выполнения**

1. **Подготовка стенда:**
   - Развёрнуты 2 машины: `client` и `backup_server`;
   - На `backup_server` создан отдельный диск и смонтирован в `/var/backup`.

2. **Установка и инициализация borg:**
   - Установлен `borgbackup` на обеих машинах;
   - На `client` создан SSH-ключ и передан на `backup_server`;
   - Выполнена инициализация зашифрованного репозитория:
     ```
     borg init --encryption=repokey ssh://backup@192.168.56.11:/var/backup/repo
     ```

3. **Создание бэкапа:**
   - Пример команды запуска вручную:
     ```
     borg create --stats --compression lz4      ssh://backup@192.168.56.11:/var/backup/repo::etc-{now:%Y-%m-%d_%H:%M} /etc
     ```
   - Параметр `::etc-{now:%Y-%m-%d_%H:%M}` задаёт имя с текущей датой/временем.

4. **Проверка содержимого репозитория:**
   ```
   borg list ssh://backup@192.168.56.11:/var/backup/repo
   ```

5. **Настройка политики хранения (prune):**
   - Оставлять:
     - последние 3 дня;
     - 1 бэкап в месяц за последние 12 месяцев;
   ```
   borg prune -v --list ssh://backup@192.168.56.11:/var/backup/repo      --keep-daily=3 --keep-monthly=12
   ```

6. **Автоматизация через скрипт:**
   - Создан Bash-скрипт `backup.sh` с логикой:
     - создание бэкапа;
     - очистка по политике;
     - вывод логов;
   - Добавлен в `cron` на ежедневный запуск.

7. **Проверка восстановления:**
   ```
   borg extract ssh://backup@192.168.56.11:/var/backup/repo::etc-2025-07-15_21:00
   ```

---

#### **Вывод**

В результате:
- настроена безопасная система резервного копирования с borg;
- реализована стратегия хранения (год назад + ежедневные за 3 месяца);
- бэкапы выполняются по расписанию;
- все действия протестированы и воспроизводимы.
